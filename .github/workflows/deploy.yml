name: Build and Deploy Library Services

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_TO_K8S: ${{ secrets.DEPLOY_TO_K8S }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build & Push Docker Images
      run: |
        docker build -t suyashsaraswat2003/book-service:latest ./services/book-service
        docker push suyashsaraswat2003/book-service:latest
        docker build -t suyashsaraswat2003/user-service:latest ./services/user-service
        docker push suyashsaraswat2003/user-service:latest
        docker build -t suyashsaraswat2003/borrow-service:latest ./services/borrow-service
        docker push suyashsaraswat2003/borrow-service:latest
        docker build -t suyashsaraswat2003/catalog-service:latest ./services/catalog-service
        docker push suyashsaraswat2003/catalog-service:latest
        docker build -t suyashsaraswat2003/frontend:latest ./frontend
        docker push suyashsaraswat2003/frontend:latest

    - name: Set up kubectl
      if: ${{ env.DEPLOY_TO_K8S == 'true' }}
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Deploy to Kubernetes
      if: ${{ env.DEPLOY_TO_K8S == 'true' }}
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > kubeconfig.yaml
        export KUBECONFIG=kubeconfig.yaml
        kubectl apply -f k8s/
        kubectl rollout status deployment/book-deployment
        kubectl rollout status deployment/user-deployment
        kubectl rollout status deployment/borrow-deployment
        kubectl rollout status deployment/catalog-deployment
        kubectl rollout status deployment/frontend-deployment

    - name: Run Docker containers locally
      if: ${{ env.DEPLOY_TO_K8S != 'true' }}
      run: |
        docker network create library-net || true
        docker run -d --name book-service --network library-net suyashsaraswat2003/book-service:latest
        docker run -d --name user-service --network library-net suyashsaraswat2003/user-service:latest
        docker run -d --name borrow-service --network library-net suyashsaraswat2003/borrow-service:latest
        docker run -d --name catalog-service --network library-net suyashsaraswat2003/catalog-service:latest
        docker run -d -p 3000:3000 --name frontend --network library-net suyashsaraswat2003/frontend:latest
